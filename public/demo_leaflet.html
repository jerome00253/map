<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet - Tileserver-GL</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            background: #f8f8f8;
            /* Background color slightly off-white */
        }

        .back-link {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 6px 12px;
            border-radius: 4px;
            text-decoration: none;
            color: #333;
            font-family: sans-serif;
            font-size: 13px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        .back-link:hover {
            background: #f0f0f0;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <a href="index.html" class="back-link">‚Üê Retour</a>

    <script>
        const host = window.location.hostname;
        const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
        const tileserverUrl = `http://${host}:8258`;

        async function initMap() {
            try {
                // Fetch dynamic config with cache-buster
                const configRes = await fetch(`/map_config.json?v=${Date.now()}`);
                const mapConfig = await configRes.json();

                const map = L.map('map', {
                    center: [47.762, 7.343],
                    zoom: 12,
                    zoomControl: false,
                    zoomSnap: 0.5,
                    zoomDelta: 0.5,
                    maxZoom: 20
                });

                const detailedBounds = L.latLngBounds(
                    [mapConfig.bbox[1], mapConfig.bbox[0]],
                    [mapConfig.bbox[3], mapConfig.bbox[2]]
                );

                // Global layer: Upscales from zoom 8 to global max limit (9)
                const globalLayer = L.tileLayer(`${tileserverUrl}/styles/bright/{z}/{x}/{y}.png`, {
                    attribution: '&copy; OpenMapTiles &copy; OpenStreetMap contributors',
                    maxNativeZoom: 8,
                    maxZoom: 9 // Global limit
                }).addTo(map);

                // Detailed layer: Native up to 18
                const detailedLayer = L.tileLayer(`${tileserverUrl}/styles/bright/{z}/{x}/{y}.png`, {
                    maxNativeZoom: 18,
                    maxZoom: 18,
                    bounds: detailedBounds
                }).addTo(map);

                const enforceZoomLimit = () => {
                    const center = map.getCenter();
                    const isInside = detailedBounds.contains(center);
                    const targetMaxZoom = isInside ? mapConfig.max_zoom_detailed : mapConfig.max_zoom_global;

                    if (map.getMinZoom() !== mapConfig.min_zoom) {
                        map.setMinZoom(mapConfig.min_zoom);
                    }

                    if (map.getMaxZoom() !== targetMaxZoom) {
                        map.setMaxZoom(targetMaxZoom);
                        if (map.getZoom() > targetMaxZoom) {
                            map.setZoom(targetMaxZoom);
                        }
                    }
                };

                map.on('move', enforceZoomLimit);
                enforceZoomLimit();

                L.control.zoom({ position: 'bottomright' }).addTo(map);
                L.control.scale({ position: 'bottomleft', imperial: false }).addTo(map);

            } catch (e) {
                console.error(e);
                document.getElementById('map').innerHTML = `<div style="padding:20px; color:#c00;">Erreur: ${e.message}</div>`;
            }
        }

        initMap();
    </script>
</body>

</html>